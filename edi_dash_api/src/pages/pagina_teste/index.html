<!DOCTYPE html>
<html>

<head>
  <title>Mapa com Polígonos (Leaflet)</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet"
    href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
  <link rel="stylesheet"
    href="https://unpkg.com/leaflet.label/leaflet.label.css" />
  <style>
    body,
    html {
      height: 100%;
      margin: 0;
      padding: 0;
    }

    #map {
      height: 80%;
      width: 100%;
    }

    button {
      margin-top: 10px;
    }

    .draw-cursor {
      cursor: pointer;
    }

    .move-cursor {
      cursor: grab;
    }

    .drawing {
      cursor: crosshair;
    }

    .label-class {
      background-color: white;
      border: 1px solid black;
      padding: 5px 100px;
      text-align: center;
      /* Aumentar o padding para melhor acomodar o texto */
      font-size: 12px;
      font-weight: bold;
    }
  </style>
</head>

<body>
  <h1>Mapa com Polígonos com coordenadas geodésicas</h1>
  <div id="map"></div>
  <button onclick="clearMarkers()">Limpar Pontos</button>
  <button onclick="drawPolygon()">Desenhar Polígono</button>
  <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
  <script
    src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.7.2/proj4.js"></script>
  <script src="https://unpkg.com/leaflet.label/leaflet.label.js"></script>
  <script>
    let map;
    let markers = [];
    let lines = [];
    let polygon = null;
    let drawingPolygon = false;

    // Função para calcular a distância entre dois pontos geodésicos
    function calculateGeodesicDistance(latlng1, latlng2) {
      const distance = L.latLng(latlng1).distanceTo(latlng2);
      return distance;
    }

    // Função para projetar coordenadas de latitude e longitude em outro sistema de coordenadas
    function projectCoordinates(latlng, targetCRS) {
      const sourceCRS = L.CRS.EPSG3857; // CRS padrão do Leaflet (projeção de mercator)

      // Verificar se a projeção de origem e destino são iguais
      if (sourceCRS === targetCRS) {
        return latlng;
      }

      // Projete as coordenadas usando a projeção alvo
      const projLatLng = L.Projection.SphericalMercator.project(latlng);
      return projLatLng;
    }

    function initMap() {
      const initialLocation = L.latLng(-23.5505, -46.6333); // São Paulo, Brasil

      map = L.map('map').setView(initialLocation, 12);

      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
      }).addTo(map);

      map.on('click', function (event) {
        placeMarkerForPolygon(event.latlng);
        placeMarker(event.latlng);
      });

      map.on('mousemove', function (event) {
        if (drawingPolygon) {
          document.body.style.cursor = 'crosshair';
        } else if (map.dragging._draggable._enabled && !drawingPolygon) {
          document.body.style.cursor = 'grab';
        } else {
          document.body.style.cursor = 'pointer';
        }
      });

      map.on('mousedown', function (event) {
        if (event.originalEvent.ctrlKey) {
          map.dragging.disable();
          document.body.style.cursor = 'grabbing';
        }
      });

      map.on('mouseup', function (event) {
        if (event.originalEvent.ctrlKey) {
          map.dragging.enable();
          document.body.style.cursor = 'grab';
        }
      });
    }

    function placeMarker(location) {
      const marker = L.marker(location).addTo(map);
      markers.push(marker);

      // Projetar as coordenadas para o sistema de coordenadas EPSG:4326 (WGS 84)
      const projectedLatLng = projectCoordinates(location, L.CRS.EPSG4326);

      updatePolygon();
      if (markers.length > 1) {
        const previousLatLng = markers[markers.length - 2].getLatLng();
        drawLine(previousLatLng, location);

        const distance = calculateGeodesicDistance(previousLatLng, location);
        const distanceLabel = `${distance.toFixed(2)} metros`;
        const lineMidpoint = L.latLngBounds([previousLatLng, location]).getCenter();
        addDistanceLabel(lineMidpoint, distanceLabel);
      }
    }

    function placeMarkerForPolygon(location) {
      if (polygon) {
        const latlngs = polygon.getLatLngs();
        latlngs.push(location);
        polygon.setLatLngs(latlngs);
      } else {
        polygon = L.polygon([location], {
          color: 'red',
          fillColor: 'red',
          fillOpacity: 0.35
        }).addTo(map);
      }

      // Projetar as coordenadas para o sistema de coordenadas EPSG:4326 (WGS 84)
      const projectedLatLng = projectCoordinates(location, L.CRS.EPSG4326);

      updatePolygon();
    }

    function drawLine(startLatLng, endLatLng) {
      const line = L.polyline([startLatLng, endLatLng], { color: 'blue' }).addTo(map);
      lines.push(line);
    }

    function addDistanceLabel(latlng, label) {
      L.marker(latlng, {
        icon: L.divIcon({
          className: 'label-class',
          html: label
        })
      }).addTo(map).bindLabel(label, { noHide: true });
    }

    function clearMarkers() {
      markers.forEach(marker => map.removeLayer(marker));
      markers = [];

      lines.forEach(line => map.removeLayer(line));
      lines = [];

      if (polygon) {
        map.removeLayer(polygon);
        polygon = null;
      }
    }

    function drawPolygon() {
      if (drawingPolygon) {
        drawingPolygon = false;
        document.body.style.cursor = 'pointer';
        if (polygon) {
          polygon.setStyle({ fillColor: 'red', fillOpacity: 0.35 });
        }
      } else {
        drawingPolygon = true;
        if (polygon) {
          map.removeLayer(polygon);
          polygon = null;
        }
        document.body.style.cursor = 'crosshair';
      }
    }
    function updatePolygon() {
      if (polygon) {
        map.removeLayer(polygon);
      }

      if (markers.length > 2) {
        const latlngs = markers.map(marker => marker.getLatLng());
        polygon = L.polygon(latlngs, {
          color: 'red',
          fillColor: 'red',
          fillOpacity: 0.5
        }).addTo(map);
      }
    }
    initMap();
  </script>
</body>

</html>



<!-- Cadastro e edição de pontos, linhas e polígonos;
Cálculos de coordenadas geodésicas e projeções cartográficas;
Importação e exportação de dados em diferentes formatos;
Geração de relatórios e mapas temáticos;
Suporte a sistemas de referência geodésicos (datum) e projeções cartográficas;
Georreferenciamento de imagens e ortorretificação;
Análise de dados espaciais e geoprocessamento. -->